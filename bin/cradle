#!/data/reddylab/software/miniconda2/envs/YoungSook/bin/python2.7

import argparse

def getArgs():
	parser = argparse.ArgumentParser("cradle")
	
	subparsers = parser.add_subparsers(help="", dest="commandName")

	########### correctBias
	correctBias_parser = subparsers.add_parser("correctBias", help="Correct shear, pcr, mappability, g-quadruplex sturcture bias from bigwig files")
	## required
	correctBias_required = correctBias_parser.add_argument_group("Required Args")

	correctBias_required.add_argument('-ctrlbw', help="Ctrl bigwig files. Un-noramlized files are recommended. Each file name should be spaced. ex) -ctrlbw file1.bw file2.bw", nargs='+', required=True)
	
	correctBias_required.add_argument('-expbw', help="Experimental bigwig files. Un-noramlized files are recommended. Each file name should be spaced. ex) -expbw file1.bw file2.bw", nargs='+', required=True)

	correctBias_required.add_argument('-l', help="Fragment length.", required=True)

	correctBias_required.add_argument('-r', help="Text file that shows regions of analysis. Each line in the text file should have chromosome, start site, and end site that are tab-sspaced", required=True)

	correctBias_required.add_argument('-biasType', help="Type of biases you want to correct among 'shear', 'pcr', 'map', 'gquad'. If you want to correct 'shear' and 'pcr' bias, you should type -biasType shear pcr. If you type either shear or pcr, tb file is required. If you type map, mappability file and length of one sequenced end is required. If you type gquad, gquadruplex score is required.", nargs='+', required=True)

	correctBias_required.add_argument('-faFile', help=".2bit file.", required=True)	
	
	
	## optional
	correctBias_optional = correctBias_parser.add_argument_group("Optional Args")	

	correctBias_optional.add_argument('-binSize', help="The size of bin for correction. default=1", default=1)

	correctBias_optional.add_argument('-mi', help="The minimum number of fragments. Positions that have less fragments than this value are filtered out. default=10", default=10)

	correctBias_optional.add_argument('-mapFile', help="Mappability file in bigwig format. Required when 'map' is in '-biasType'")

	correctBias_optional.add_argument('-kmer', help="The length of one sequencing end. Required when 'map' is in '-biasType'")

	correctBias_optional.add_argument('-gquadFile', help="Gqaudruplex file in bigwig format. Required when 'gquad' is in '-biasType'", nargs="+")

	correctBias_optional.add_argument('-gquadMax', help="The maximum gquad score. This is used to normalize Gquad score. default=78.6", default=78.6)
	
	correctBias_optional.add_argument('-o', help="Output directoy")

	correctBias_optional.add_argument('-p', help="The number of cpus. default=(available cpus)/2")

	correctBias_optional.add_argument('-bl', help="Blacklist regions")



	########### correctBias_stored
        correctBiasStored_parser = subparsers.add_parser("correctBias_stored", help="Correct shear, pcr, mappability, g-quadruplex sturcture bias from bigwig files when there are stored covariate hdf5 files. This is much faster than correctBias.")
	## required
	correctBiasStored_required = correctBiasStored_parser.add_argument_group("Required Args")

	correctBiasStored_required.add_argument('-ctrlbw', help="Ctrl bigwig files. Un-noramlized files are recommended. Each file name should be spaced. ex) -ctrlbw file1.bw file2.bw", nargs='+', required=True)

	correctBiasStored_required.add_argument('-expbw', help="Experimental bigwig files. Un-noramlized files are recommended. Each file name should be spaced. ex) -expbw file1.bw file2.bw", nargs='+', required=True)

	correctBiasStored_required.add_argument('-r', help="Text file that shows regions of analysis. Each line in the text file should have chromosome, start site, and end site that are tab-sspaced", required=True)

	correctBiasStored_required.add_argument('-biasType', help="Type of biases you want to correct among 'shear', 'pcr', 'map', 'gquad'. If you want to correct 'shear' and 'pcr' bias, you should type -biasType shear pcr. If you type either shear or pcr, tb file is required. If you type map, mappability file and length of one sequenced end is required. If you type gquad, gquadruplex score is required.", nargs='+', required=True)

	correctBiasStored_required.add_argument('-covariDir', help="the directory of hdf files that have covariate values", required=True)

	correctBiasStored_required.add_argument('-faFile', help=".2bit file.", required=True)

	## optional
	correctBiasStored_optional = correctBiasStored_parser.add_argument_group("Optional Args")

	correctBiasStored_optional.add_argument('-mi', help="The minimum number of fragments. Positions that have less fragments than this value are filtered out. default=10", default=10)

	correctBiasStored_optional.add_argument('-o', help="Output directoy")

	correctBiasStored_optional.add_argument('-p', help="The number of cpus. default=(available cpus)/2")

	correctBiasStored_optional.add_argument('-bl', help="Blacklist regions")



	########### callPeak
	callPeak_parser = subparsers.add_parser("callPeak", help="Correct peaks with corrected bigwig files")
	## required
	callPeak_required = callPeak_parser.add_argument_group("Required Args")

	callPeak_required.add_argument('-ctrlbw', help="Ctrl bigwig files. Corrected bigwig files are recommended. Each file name should be spaced. ex) -ctrlbw file1.bw file2.bw", nargs='+', required=True)

	callPeak_required.add_argument('-expbw', help="Experimental bigwig files. Corrected bigwig files are recommended. Each file name should be spaced. ex) -expbw file1.bw file2.bw", nargs='+', required=True)

	callPeak_required.add_argument('-l', help="Fragment length.", required=True)

	callPeak_required.add_argument('-r', help="Text file that shows regions of analysis. Each line in the text file should have chromosome, start site, and end site that are tab-spaced.", required=True)

	callPeak_required.add_argument('-fdr', help="FDR level", required=True)

	## optional
	callPeak_optional = callPeak_parser.add_argument_group("Optional Args")

	callPeak_optional.add_argument('-o', help="Output directoy")

	callPeak_optional.add_argument('-bl', help="Blacklist regions")

	callPeak_optional.add_argument('-rbin', help="The size of bin used for defining regions, default = (fragment length)*1.5")

	callPeak_optional.add_argument('-wbin', help="he size of bin used for testing differential activity, default = rbin/6")

	callPeak_optional.add_argument('-p', help="The number of cpus. default=(available cpus)/2")

	return parser


def main():
	
	args = getArgs().parse_args()

	### Correcting bias 
	if(args.commandName == "correctBias"):
		from CRADLE.CorrectBias.correctBias import run # excectue 'def run' in correctBias.py 
		run(args)

	### Correcting bias when there are stored covariates
	if(args.commandName == "correctBias_stored"):
                from CRADLE.CorrectBiasStored.correctBias_stored import run
                run(args)

	### Call peaks
	if(args.commandName == "callPeak"):
                from CRADLE.CallPeak.callPeak import run
                run(args)	


if __name__ == '__main__':
	main()





